import json
from datetime import date, datetime

import pytest

from authn.models.user import User
from utils.gdpr_backup_data import GDPRDataRestore


def serialize_data(data: list) -> str:
    return json.dumps(
        data,
        default=lambda x: x.isoformat() if isinstance(x, (datetime, date)) else None,
    )


@pytest.mark.parametrize(
    argnames="user_id,gdpr_back_up_data, expected, create_fixture",
    argvalues=[
        (5, "{}", False, False),
        (
            2,
            serialize_data(
                [
                    {
                        "table": "user",
                        "primary_key": {"column": "id", "value": 375364},
                        "data": {
                            "id": 2,
                            "esp_id": "1ade317a-3744-4366-a4e3-229655e45744",
                            "api_key": "cc081546-efc5-4d73-a000-508b7f84c61c",
                            "email": "kfsnfkdnf@ndsnd.com",
                            "username": None,
                            "first_name": "nkrenrkne",
                            "middle_name": None,
                            "last_name": "nfkdnfk",
                            "active": 1,
                            "email_confirmed": 0,
                            "password": "pbkdf2:sha256:10000$gdijhCWfRomI$d2053c4b795bc7ca3e57247958db6c8eedc97d2f41110d588db529c1b255f4c4",
                            "image_id": None,
                            "otp_secret": None,
                            "country_id": None,
                            "timezone": "UTC",
                            "zendesk_user_id": None,
                            "created_at": "2023-04-19T18:09:06",
                            "modified_at": "2023-04-19T18:09:06",
                            "mfa_state": "DISABLED",
                            "sms_phone_number": None,
                            "authy_id": None,
                        },
                    }
                ]
            ),
            True,
            False,
        ),
        (
            54321,
            serialize_data(
                [
                    {
                        "table": "ca_member_match_log",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 325708,
                            "user_id": 54321,
                            "care_advocate_id": 54321,
                            "country_id": None,
                            "organization_id": 1,
                            "track": "pregnancy",
                            "user_flag_ids": "",
                            "attempts": 1,
                            "matched_at": "2023-08-15T19:38:16",
                            "country_code": "US",
                        },
                    },
                    {
                        "table": "member_care_team",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 2141188,
                            "user_id": 54321,
                            "practitioner_id": 54321,
                            "type": "CARE_COORDINATOR",
                            "json": "{}",
                            "modified_at": "2023-08-15T19:38:16",
                            "created_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "member_care_team",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 2141188,
                            "user_id": 54321,
                            "practitioner_id": 54321,
                            "type": "CARE_COORDINATOR",
                            "json": "{}",
                            "modified_at": "2023-08-15T19:38:16",
                            "created_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "member_care_team",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 2141188,
                            "user_id": 54321,
                            "practitioner_id": 54321,
                            "type": "CARE_COORDINATOR",
                            "json": "{}",
                            "modified_at": "2023-08-15T19:38:16",
                            "created_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "user_activity",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 6083,
                            "user_id": 54321,
                            "activity_type": "last_login",
                            "activity_date": "2023-08-15T19:38:35",
                            "created_at": "2023-08-15T19:38:34",
                            "modified_at": "2023-08-15T19:38:34",
                        },
                    },
                    {
                        "table": "schedule",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "modified_at": "2023-08-15T19:38:11",
                            "created_at": "2023-08-15T19:38:11",
                            "id": 636879,
                            "name": "Schedule for QATest User",
                            "user_id": 54321,
                        },
                    },
                    {
                        "table": "health_profile",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "modified_at": "2023-08-15T19:38:14",
                            "created_at": "2023-08-15T19:38:11",
                            "user_id": 54321,
                            "json": '{"abortions": None, "full_term_babies": None, "gender": None, "number_of_pregnancies": None, "weight": None, "health_issues_past": None, "medications_current": None, "miscarriages": None, "medications_past": None, "height": None, "birthday": "2000-01-01", "due_date": "2024-04-15", "food_allergies": None, "health_issues_current": None, "insurance": None, "medications_allergies": None, "premature_babies": None}',
                            "bmi_persisted": None,
                            "age_persisted": 23,
                            "children_persisted": "[]",
                            "children_with_age_persisted": "[]",
                            "last_child_birthday_persisted": None,
                        },
                    },
                    {
                        "table": "user_auth",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 207,
                            "user_id": 54321,
                            "external_id": "auth0|64259f3e7669841963b9536d",
                            "refresh_token": None,
                        },
                    },
                    {
                        "table": "organization_employee",
                        "primary_key": {
                            "column": "email",
                            "value": "bd851c3b444cf204ca0b5ca94349d1e2@mavenclinic.test",
                        },
                        "data": {
                            "id": 25630,
                            "dependent_id": "",
                            "organization_id": 121,
                            "retention_start_date": None,
                            "alegeus_id": None,
                            "eligibility_member_id": None,
                            "email": "test+mvnqa-1692128291130@mavenclinic.com",
                            "deleted_at": None,
                            "date_of_birth": "2021-10-29",
                            "json": {
                                "address": {
                                    "employee_first_name": "Luanne",
                                    "employee_last_name": "Mendell",
                                    "address_1": "84 Waterford Knoll",
                                    "address_2": "",
                                    "city": "",
                                    "state": "AL",
                                    "zip_code": "36663",
                                    "country": "Borders",
                                }
                            },
                            "first_name": "Dionna",
                            "modified_at": "2020-05-06T18:04:45",
                            "last_name": "Paglialunga",
                            "created_at": "2020-05-06T18:04:45",
                            "work_state": "Tennessee",
                            "unique_corp_id": "552688",
                        },
                    },
                    {
                        "table": "user_organization_employee",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 3336923,
                            "user_id": 54321,
                            "organization_employee_id": 25630,
                            "ended_at": None,
                        },
                    },
                    {
                        "table": "credit",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "modified_at": "2023-08-15T19:38:29",
                            "created_at": "2023-08-15T19:38:15",
                            "id": 657638,
                            "user_id": 54321,
                            "amount": 2000.0,
                            "activated_at": "2023-08-15T19:38:15",
                            "used_at": None,
                            "expires_at": "2023-08-15T19:38:29",
                            "appointment_id": None,
                            "referral_code_use_id": None,
                            "message_billing_id": None,
                            "organization_package_id": None,
                            "organization_employee_id": 25630,
                            "json": "{}",
                            "eligibility_member_id": 112513,
                            "eligibility_verification_id": None,
                        },
                    },
                    {
                        "table": "user_onboarding_state",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "id": 573101,
                            "user_id": 54321,
                            "state": "ASSESSMENTS",
                            "created_at": "2023-08-15T19:38:11",
                            "modified_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "role",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {"id": 6, "name": "marketing_staff"},
                    },
                    {
                        "table": "member_profile",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "modified_at": "2023-08-15T19:38:15",
                            "note": None,
                            "follow_up_reminder_send_time": None,
                            "zendesk_verification_ticket_id": None,
                            "created_at": "2023-08-15T19:38:11",
                            "user_id": 54321,
                            "role_id": 6,
                            "state_id": None,
                            "phone_number": "tel:+1-201-555-0123",
                            "dosespot": "{}",
                            "stripe_customer_id": "cus_OSNpamQ7Vpvlxk",
                            "stripe_account_id": None,
                            "json": '{"opted_in_notes_sharing": True}',
                            "has_care_plan": 0,
                            "care_plan_id": None,
                            "country_id": None,
                            "first_name": "QATest",
                            "middle_name": None,
                            "last_name": "User",
                            "username": None,
                            "zendesk_user_id": None,
                            "timezone": "UTC",
                            "country_code": "US",
                            "subdivision_code": "US-NY",
                            "esp_id": "e0fddc4b-5f40-4cd4-8da4-44e8c71e3d3e",
                            "email": None,
                        },
                    },
                    {
                        "table": "user",
                        "foreign_key": {"column": "id", "value": 54321},
                        "data": {
                            "modified_at": "2023-08-15T19:38:28",
                            "created_at": "2023-08-15T19:38:11",
                            "id": 54321,
                            "esp_id": "e335494d-1a6f-45db-b84e-47f47a7820f5",
                            "first_name": "QATest",
                            "middle_name": None,
                            "last_name": "User",
                            "username": None,
                            "active": 0,
                            "email_confirmed": 0,
                            "email": "test+mvnqa-1692128291130@mavenclinic.com",
                            "password": "pbkdf2:sha256:10000$akd7iyJvpP3v$6508a60b9e1ca66766683bf332b80edd89de8f72f25ca75821c8b2a81df331c2",
                            "api_key": "d1bb9438-bec5-4f7b-aece-a1a707d840d6",
                            "image_id": None,
                            "otp_secret": None,
                            "country_id": None,
                            "timezone": "UTC",
                            "zendesk_user_id": None,
                            "mfa_state": "DISABLED",
                            "sms_phone_number": None,
                            "authy_id": None,
                        },
                    },
                    {
                        "table": "member_track",
                        "foreign_key": {"column": "user_id", "value": 54321},
                        "data": {
                            "organization_employee_id": 25630,
                            "created_at": "2023-08-15T19:38:15",
                            "previous_member_track_id": None,
                            "eligibility_member_id": 112513,
                            "id": 496981,
                            "bucket_id": "18d47a71-0866-41e5-aa88-a0d86482123d",
                            "legacy_module_id": None,
                            "is_employee": True,
                            "name": "pregnancy",
                            "closure_reason_id": None,
                            "auto_transitioned": False,
                            "transitioning_to": None,
                            "active": False,
                            "start_date": "2023-08-15",
                            "client_track_id": 2286,
                            "activated_at": "2023-08-15T19:38:15",
                            "anchor_date": "2023-07-17",
                            "inactive": True,
                            "ended_at": "2023-08-15T19:38:29",
                            "user_id": 54321,
                            "scheduled": False,
                            "legacy_program_id": None,
                            "modified_at": "2023-08-15T19:38:29",
                        },
                    },
                    {
                        "table": "member_track_phase",
                        "foreign_key": {"column": "member_track_id", "value": 496981},
                        "data": {
                            "name": "week-5",
                            "id": 2579665,
                            "modified_at": "2023-08-15T19:38:29",
                            "legacy_program_phase_id": None,
                            "started_at": "2023-08-15T00:00:00",
                            "member_track_id": 496981,
                            "created_at": "2023-08-15T19:38:15",
                            "ended_at": "2023-08-15T00:00:00",
                        },
                    },
                ]
            ),
            False,
            False,
        ),
        (
            12345,
            serialize_data(
                [
                    {
                        "table": "ca_member_match_log",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 325708,
                            "user_id": 12345,
                            "care_advocate_id": 12345,
                            "country_id": None,
                            "organization_id": 1,
                            "track": "pregnancy",
                            "user_flag_ids": "",
                            "attempts": 1,
                            "matched_at": "2023-08-15T19:38:16",
                            "country_code": "US",
                        },
                    },
                    {
                        "table": "member_care_team",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 2141188,
                            "user_id": 12345,
                            "practitioner_id": 2345,
                            "type": "CARE_COORDINATOR",
                            "json": "{}",
                            "modified_at": "2023-08-15T19:38:16",
                            "created_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "user_activity",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 6083,
                            "user_id": 12345,
                            "activity_type": "last_login",
                            "activity_date": "2023-08-15T19:38:35",
                            "created_at": "2023-08-15T19:38:34",
                            "modified_at": "2023-08-15T19:38:34",
                        },
                    },
                    {
                        "table": "schedule",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "modified_at": "2023-08-15T19:38:11",
                            "created_at": "2023-08-15T19:38:11",
                            "id": 636879,
                            "name": "Schedule for QATest User",
                            "user_id": 12345,
                        },
                    },
                    {
                        "table": "health_profile",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "modified_at": "2023-08-15T19:38:14",
                            "created_at": "2023-08-15T19:38:11",
                            "user_id": 12345,
                            "json": '{"abortions": None, "full_term_babies": None, "gender": None, "number_of_pregnancies": None, "weight": None, "health_issues_past": None, "medications_current": None, "miscarriages": None, "medications_past": None, "height": None, "birthday": "2000-01-01", "due_date": "2024-04-15", "food_allergies": None, "health_issues_current": None, "insurance": None, "medications_allergies": None, "premature_babies": None}',
                            "bmi_persisted": None,
                            "age_persisted": 23,
                            "children_persisted": "[]",
                            "children_with_age_persisted": "[]",
                            "last_child_birthday_persisted": None,
                        },
                    },
                    {
                        "table": "user_auth",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 207,
                            "user_id": 12345,
                            "external_id": "auth0|64259f3e7669841963b9536d",
                            "refresh_token": None,
                        },
                    },
                    {
                        "table": "organization_employee",
                        "primary_key": {
                            "column": "email",
                            "value": "bd851c3b444cf204ca0b5ca94349d1e2@mavenclinic.test",
                        },
                        "data": {
                            "id": 25630,
                            "dependent_id": "",
                            "organization_id": 121,
                            "retention_start_date": None,
                            "alegeus_id": None,
                            "eligibility_member_id": None,
                            "email": "test+mvnqa-1692128291130@mavenclinic.com",
                            "deleted_at": None,
                            "date_of_birth": "2021-10-29",
                            "json": {
                                "address": {
                                    "employee_first_name": "Luanne",
                                    "employee_last_name": "Mendell",
                                    "address_1": "84 Waterford Knoll",
                                    "address_2": "",
                                    "city": "",
                                    "state": "AL",
                                    "zip_code": "36663",
                                    "country": "Borders",
                                }
                            },
                            "first_name": "Dionna",
                            "modified_at": "2020-05-06T18:04:45",
                            "last_name": "Paglialunga",
                            "created_at": "2020-05-06T18:04:45",
                            "work_state": "Tennessee",
                            "unique_corp_id": "552688",
                        },
                    },
                    {
                        "table": "user_organization_employee",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 3336923,
                            "user_id": 12345,
                            "organization_employee_id": 25630,
                            "ended_at": None,
                        },
                    },
                    {
                        "table": "credit",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "modified_at": "2023-08-15T19:38:29",
                            "created_at": "2023-08-15T19:38:15",
                            "id": 657638,
                            "user_id": 12345,
                            "amount": 2000.0,
                            "activated_at": "2023-08-15T19:38:15",
                            "used_at": None,
                            "expires_at": "2023-08-15T19:38:29",
                            "appointment_id": None,
                            "referral_code_use_id": None,
                            "message_billing_id": None,
                            "organization_package_id": None,
                            "organization_employee_id": 25630,
                            "json": "{}",
                            "eligibility_member_id": 112513,
                            "eligibility_verification_id": None,
                        },
                    },
                    {
                        "table": "user_onboarding_state",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "id": 573101,
                            "user_id": 12345,
                            "state": "ASSESSMENTS",
                            "created_at": "2023-08-15T19:38:11",
                            "modified_at": "2023-08-15T19:38:16",
                        },
                    },
                    {
                        "table": "role",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {"id": 6, "name": "marketing_staff"},
                    },
                    {
                        "table": "member_profile",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "modified_at": "2023-08-15T19:38:15",
                            "note": None,
                            "follow_up_reminder_send_time": None,
                            "zendesk_verification_ticket_id": None,
                            "created_at": "2023-08-15T19:38:11",
                            "user_id": 12345,
                            "role_id": 6,
                            "state_id": None,
                            "phone_number": "tel:+1-201-555-0123",
                            "dosespot": "{}",
                            "stripe_customer_id": "cus_OSNpamQ7Vpvlxk",
                            "stripe_account_id": None,
                            "json": '{"opted_in_notes_sharing": True}',
                            "has_care_plan": 0,
                            "care_plan_id": None,
                            "country_id": None,
                            "first_name": "QATest",
                            "middle_name": None,
                            "last_name": "User",
                            "username": None,
                            "zendesk_user_id": None,
                            "timezone": "UTC",
                            "country_code": "US",
                            "subdivision_code": "US-NY",
                            "esp_id": "e0fddc4b-5f40-4cd4-8da4-44e8c71e3d3e",
                            "email": None,
                        },
                    },
                    {
                        "table": "user",
                        "foreign_key": {"column": "id", "value": 12345},
                        "data": {
                            "modified_at": "2023-08-15T19:38:28",
                            "created_at": "2023-08-15T19:38:11",
                            "id": 12345,
                            "esp_id": "e335494d-1a6f-45db-b84e-47f47a7820f5",
                            "first_name": "QATest",
                            "middle_name": None,
                            "last_name": "User",
                            "username": None,
                            "active": 0,
                            "email_confirmed": 0,
                            "email": "test+mvnqa-1692128291130@mavenclinic.com",
                            "password": "pbkdf2:sha256:10000$akd7iyJvpP3v$6508a60b9e1ca66766683bf332b80edd89de8f72f25ca75821c8b2a81df331c2",
                            "api_key": "d1bb9438-bec5-4f7b-aece-a1a707d840d6",
                            "image_id": None,
                            "otp_secret": None,
                            "country_id": None,
                            "timezone": "UTC",
                            "zendesk_user_id": None,
                            "mfa_state": "DISABLED",
                            "sms_phone_number": None,
                            "authy_id": None,
                        },
                    },
                    {
                        "table": "member_track",
                        "foreign_key": {"column": "user_id", "value": 12345},
                        "data": {
                            "organization_employee_id": 25630,
                            "created_at": "2023-08-15T19:38:15",
                            "previous_member_track_id": None,
                            "eligibility_member_id": 112513,
                            "id": 496981,
                            "bucket_id": "18d47a71-0866-41e5-aa88-a0d86482123d",
                            "legacy_module_id": None,
                            "is_employee": True,
                            "name": "pregnancy",
                            "closure_reason_id": None,
                            "auto_transitioned": False,
                            "transitioning_to": None,
                            "active": False,
                            "start_date": "2023-08-15",
                            "client_track_id": 2286,
                            "activated_at": "2023-08-15T19:38:15",
                            "anchor_date": "2023-07-17",
                            "inactive": True,
                            "ended_at": "2023-08-15T19:38:29",
                            "user_id": 12345,
                            "scheduled": False,
                            "legacy_program_id": None,
                            "modified_at": "2023-08-15T19:38:29",
                        },
                    },
                    {
                        "table": "member_track_phase",
                        "foreign_key": {"column": "member_track_id", "value": 496981},
                        "data": {
                            "name": "week-5",
                            "id": 2579665,
                            "modified_at": "2023-08-15T19:38:29",
                            "legacy_program_phase_id": None,
                            "started_at": "2023-08-15T00:00:00",
                            "member_track_id": 496981,
                            "created_at": "2023-08-15T19:38:15",
                            "ended_at": "2023-08-15T00:00:00",
                        },
                    },
                ]
            ),
            True,
            True,
        ),
    ],
    ids=[
        "empty data, should not restore",
        "user table only, should restore successfully",
        "lots of tables, all dependent tables  not present. should not restore successfully",
        "lots of tables, all dependent tables present. should restore successfully",
    ],
)
def test_gdpr_data_restore(
    factories, user_id, gdpr_back_up_data, expected, create_fixture, db
):
    if create_fixture:
        factories.RoleFactory.create(id=6, name="test")
        factories.OrganizationFactory.create(id=1)
        factories.PractitionerProfileFactory.create(
            user_id=factories.DefaultUserFactory.create(id=2345).id
        )

    user_data_restore = GDPRDataRestore(db.session)
    factories.GDPRDeletionBackupFactory.create(user_id=user_id, data=gdpr_back_up_data)

    #  check no such user
    assert not db.session.query(User).filter(User.id == user_id).count()
    result = user_data_restore.restore_data(user_id)

    # no problems in execution
    assert result == expected

    # check user was restored successfully
    if expected:
        assert db.session.query(User).filter(User.id == user_id).count()
